---
title: "Mosquito Metagenomics"
author: "Cole Baril"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: lumen
    code_download: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warnings = FALSE)
```

```{=html}
<style>
   table {
     display: block;
     overflow: auto;
   }

   blockquote {
   background-color: #33638dff;
   color:white;
  }

 </style>
```


# Libraries

```{r, load_libraries, message = FALSE, warning = FALSE}
require(pacman)
pacman::p_load(tidyverse, janitor, here, DT, gt, phylotools, assertr, readxl, patchwork, reshape2, ggtext, openxlsx, grid, tiff)
```

# Links to Files

Some files generated are too large to store on GitHub (e.g., contig sequences, publication-quality images). Large files can be accessed from DropBox folders below:

[Dropbox link to raw assemblies separated by sample](https://www.dropbox.com/s/m194auk7oxlpnwa/Contigs.zip?dl=0)

[Dropbox link to raw assemblies concatenated into a .csv](https://www.dropbox.com/s/2khujpa8bn5w8k6/contigs_raw.zip?dl=0)

[Dropbox link to publication quality figures](https://www.dropbox.com/sh/2lw74xdap2ofxtb/AAACTMIU-ipvd0GgKVGxuzjma?dl=0)

Raw RNA sequencing reads can be retrieved from the NCBI short sequence read archive under the SRA accession number PRJNA793247.

# Re-BLAST 2023

Due to the significant changes to GenBank we are re-BLASTing results. To speed things up, I am curating custom BLAST databases using sequences downloaded from GenBank's Nucleotide database using Entrez Queries to eliminate sequences that are extremely unlikely to be present in our samples that make up a large portion of the Nucleotide database. BLAST is being run locally using CLC Genomics Workbench. For example, eliminating the top few viruses (unlikely to be found in mosquitoes) in the nucleotide database reduces the number of sequences by 90%. 

## Viruses

**Entrez Query:**

Viruses [ORGN] NOT Coronavirus [ORGN] NOT Human immunodeficiency virus 1 [ORGN] NOT Influenza A virus [ORGN] NOT Hepacivirus C [ORGN] NOT Hepatitis B virus [ORGN] NOT Influenza B virus [ORGN] NOT Rotavirus A [ORGN] NOT Norwalk virus [ORGN] NOT Simian immunodeficiency virus [ORGN] 

# Non-Virus Sequences

Non-virus sequences (e.g., Fungi, parasites, bacteria, plants, vertebrates) were considerably lower in overall number as well as quality. Furthermore, for these reasons, it was difficult to discern species from the recovered sequences. Some of the reasons for this is that compared to viruses where often we recovered the near complete genome, for fungi, parasites, bacteria, plants and vertebrates we recovered mostly rRNA, mitochondrial sequences, or in the case of plants, chloroplast sequences. Therefore, we decided to conduct analyses for non-virus sequences recovered at a higher level (e.g., Family, Genus) rather than species. This still gives us a good idea about what organisms are harboured by mosquitoes. 

# Methods

## Host and Quality Filtering

Chan Zuckerberg ID Metagenomic Pipeline v6.8 (Chan Zuckerberg Biohub; CZID), an open-sourced cloud-based bioinformatics platform (https://czid.org/) was used for quality control and host filtration of reads as well as de novo assembly and taxonomic binning as described by Batson et al., (2021) and Kalantar et al., (2020). The CZID pipeline employs STAR and Bowtie2 to perform host filtration (human and mosquito), Trimmomatic for adapter trimming, Price Seq for removal of low-quality reads, LZW for the removal of low complexity reads and CZIDdedup for duplicate read identification.

## *De Novo* Assembly

The host and quality filtered reads were allowed to continue through the CZID pipeline, which involves de novo assembly with SPADES using default settings and only the assembly module. After assembly, reads are mapped back to contigs with Bowtie2. The host and quality filtered reads from CZID (the Bowtie2 output) were downloaded and assembled with the CLC Genomics Workbench version 20 assembler with a minimum contig length of 250 nt, mismatch cost of 2, insertion cost of 3, deletion cost of 3, length fraction of 0.7 and a similarity fraction of 0.95. Contigs were subject to BLASTn and BLASTp searches on the NCBI nt and nr databases, respectively. The BLAST results were very similar between CZID and CLC, thus we opted to use CLC Genomics Workbench version 20 for subsequent analyses.

## BLAST

Assembled contigs were subject to BLASTn searches on the NCBI non-redundant nucleotide and protein databases, respectively and contigs were assigned to taxa based on BLAST results. Positive contigs from BLASTn searches were searched against the BLASTp database on a per-sequence basis to save computational time. We were looking for non-mosquito sequences of viral, bacterial, parasitic, fungal and plant origin and discarded sequences that were of mosquito origin.

## Analysis of BLAST results

To begin, BLASTn search results were filtered by E-value (≤1x 10<sup>-100</sup>) and contig length (≥250). Contigs with a match length of ≥250 nt, ≥90% for both nt and aa sequence similarity were classified as hits. Coverage depth was analyzed on a per-sequence basis: for viruses, we used a minimum threshold of 10X coverage depth, and we were less strict for protozoan, fungal, bacterial, plant and chordate read. Contigs meeting these criteria were further scrutinized through analysis of protein function using the NCBI ORFfinder (minimum length: 150 nt, standard genetic code, “ATG” only) and NCBI conserved domains tools. The most likely ORF was used for analysis based on the NCBI ORFfinder output.

Contigs with a percent nt identity <90% were flagged as potentially novel and were subject to phylogenetic analysis. While the ICTV sets specific standards for different viral taxa for percent identity to claim a novel virus, many of the viruses we recovered are unclassified beyond the order or family classification, which can make selecting an identity threshold difficult. Therefore, we selected ≤90% as the cut-off because Kalantar et al., (2020) suggests that <90% nt identity is a good general threshold.

# Fungi

```{r, read_fungi}
fungi <- read_excel(here("Raw/Meta2.xlsx"),
                        sheet = "Fungi") %>% 
  row_to_names(1) %>% clean_names() %>% 
  mutate(sample_number = as.integer(sample_number)) %>% 
  mutate(nt_reads = as.numeric(nt_reads)) %>% 
  select(-"na", -"depth", -"nt_rpm", -"nr_rpm":-last_col()) %>% 
  drop_na(sample_number)
```

```{r, fungi_stats}
sum(fungi$nt_reads)
n_distinct(fungi$name)
n_distinct(fungi$fungal_division_or_phylum)
n_distinct(fungi$mosquito_species)
unique(fungi$mosquito_species)
```

> A total of 71,673 reads representing 27 distinct fungal organisms from 6 higher taxon groups were detected in 5 mosquito species: 
>
>- *Culex tarsalis*
>
>- *Coquillettidia perturbans*
>
>- *Aedes vexans*
>
>- *Ochlerotatus dorsalis*
>
>- *Anopheles earlei*
>
> The majority of fungal organisms detected were Microsporidians (59%). 16 unique microsporidians were detected. The majority of microsporidians were detected in *Cx. tarsalis* samples, with 11 distinct microsporidians identified. 

```{r, display_fungi_figure}
grid::grid.raster(tiff::readTIFF( here("Figures/distinct_fungi_organisms.tiff")))
```


# Viruses 

```{r, read_data}
virus_master_2023 <- read_csv(here("Data/virus_master_2023.csv"))

n_sample <- virus_master_2023 %>% 
  distinct(sample_number) %>% 
  mutate(sample_number = as.integer(sample_number)) %>% 
  arrange(sample_number)

nrow(n_sample)

virus_master_2023 %>% 
  distinct(mosquito_species) %>% gt()
```

> Contigs representing viruses were detected in 44 of 45 mosquito samples. Viral sequences were detected in samples from eight mosquito species:
>
> - *Anopheles earlei*
>
> - *Culex tarsalis*
>
> - *Coquillettidia perturbans*
>
> - *Aedes canadensis*
>
> - *Aedes vexans*
>
> - *Ochlerotatus flavescens*
>
> - *Ochlerotatus triseriatus*
>
> - *Ochlerotatus dorsalis*
>
> - *Anopheles earlei*

# Virus Summary 

```{r, exec_summary}
virus_master_2023 %>% 
  group_by(virus_name) %>% 
  summarise(max_contig = max(contig_length),
            min_contig = min(contig_length),
            avg_nt_id = mean(greatest_identity_percent),
            max_nt_id = max(greatest_identity_percent),
            min_nt_id = min(greatest_identity_percent)

            ) %>% 
  left_join(reshape2::dcast(virus_master_2023, virus_name ~ mosquito_species)) %>% 
  rename("Ae. vexans contigs" = "Aedes vexans",
         "Cx. tarsalis contigs" = "Culex tarsalis") %>% 
  mutate(novel_flag = case_when(min_nt_id < 90 ~ "Presumptive Novel", TRUE ~ "Not Novel")) %>% 
  gt() %>% 
    fmt_number(
      columns = everything(),
      decimals = 2
    )
```


# Virus Profiles

> Below are summaries for each virus detected. 

```{r, virus_table}
virus_profile_table <- function(virus) {

 virus_table <<-  virus_master_2023 %>% 
  filter(virus_name == virus) %>% 
  #select(-"contig_sequences") %>% 
  summarise(
    num_species = n_distinct(mosquito_species),
    num_contig = n(),
    longest_contig = max(contig_length),
    shortest_contig = min(contig_length),
    avg_nt_id = mean(greatest_identity_percent),
    max_nt_id = max(greatest_identity_percent),
    min_nt_id = min(greatest_identity_percent)
    
  ) %>% 
  gt() %>% 
  cols_label(
    longest_contig = "Max Contig",
    shortest_contig = "Min Contig",
    avg_nt_id = "Average Nt Id",
    max_nt_id = "Max Nt Id",
    min_nt_id = "Min Nt Id",
    num_contig = "n Contigs",
    num_species = "n Species"
  ) %>% 
  tab_header(
    title = paste0("Summary Stats for", " ", virus)
  ) %>% 
    fmt_number(
      columns = 4:last_col(),
      decimals = 2
    )

}
  
```



```{r, virus_profiles, results = 'asis'}
# Arrange df for virus reporting
virus_master_2023 <<- virus_master_2023 %>% 
  arrange(desc(genome)) %>% 
  drop_na(virus_name)

for(virus in unique(virus_master_2023$virus_name)) {

  genome <- virus_master_2023 %>% 
    arrange(desc(genome)) %>% 
    drop_na(virus_name) %>%  
    filter(virus_name == virus) %>% 
    pull(genome) %>% 
    head(1)
  
  genome <- paste0(genome)
  
  family <- virus_master_2023 %>% 
    filter(virus_name == virus) %>% 
    pull(viral_family) %>% 
    head(1)
  
  family <- paste0(family)

  sample_detections <- virus_master_2023 %>% 
    filter(virus_name == virus) %>% 
    distinct(sample_number)
  sample_detections <- paste0(nrow(sample_detections))
  
  
  cat('\n\n##', virus, '\n\n')
  
  cat('\n\n', virus, 'has a ', genome, 'genome and is a member of the family', family, 'and was detected in', sample_detections, 'samples.', 'See summary figures and tables below.',  '\n\n')
  
print(suppressMessages(
  virus_master_2023 %>% 
    filter(virus_name == virus) %>% 
    select(-"contig_sequence") %>% 
    group_by(mosquito_species, collection_year, location_pool) %>% 
    summarise(n = n_distinct(sample_number)) %>% 
    ggplot(aes(x = mosquito_species, y = n, fill = location_pool)) +
    geom_col() +
    facet_grid(. ~ collection_year) +
    scale_fill_viridis_d("Location", option = "magma") +
    theme_bw() +
    labs(title = paste0("Number of Virus Detections"),
       subtitle = paste0("For ", virus, " by Year, Species and Location")) +
    theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.5))
  ))
  
  cat('\n\n###', 'Years {.unlisted .unnumbered}', '\n\n')

  print(htmltools::tagList(
    virus_master_2023 %>% 
      filter(virus_name == virus) %>% 
      group_by(collection_year) %>% 
      summarise(n = n_distinct(sample_number)) %>% 
      gt() %>% 
      cols_label(collection_year = "Year(s) Detected")
    ))
  
  cat('\n\n###', 'Locations {.unlisted .unnumbered}', '\n\n')
  
    print(htmltools::tagList(
    virus_master_2023 %>% 
      filter(virus_name == virus) %>% 
      group_by(location_pool) %>% 
      summarise(n = n_distinct(sample_number)) %>% 
      gt() %>% 
      cols_label(location_pool = "Location(s) Detected")
    ))
    
    cat('\n\n###', 'Mosquito Species {.unlisted .unnumbered}', '\n\n')
  
    print(htmltools::tagList(
    virus_master_2023 %>% 
      filter(virus_name == virus) %>% 
      group_by(mosquito_species) %>% 
      summarise(n = n_distinct(sample_number)) %>% 
      gt() %>% 
      cols_label(mosquito_species = "Mosquito Hosts")
    ))
    
    cat('\n\n###', 'Contig Summary {.unlisted .unnumbered}', '\n\n')

  virus_profile_table(virus)
  
  
  print(htmltools::tagList(virus_table))
  
}


```


# Save Data

```{r, save_data}
virus_master_2023 %>% 
  write.csv(here("virus_master_2023.csv"))
```
